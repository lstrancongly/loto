<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="L√¥ T√¥ T·∫øt">
    <title>L√î T√î T·∫æT 2026 - PRO VERSION</title>
    <style>
        :root { --red: #d32f2f; --gold: #f1c40f; --dark: #1a1a1a; --white: #ffffff; --green: #2e7d32; --bg: #7d0000; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); margin: 0; padding: env(safe-area-inset-top) 10px 10px 10px; color: var(--dark); overflow-x: hidden; }
        
        .main-layout { display: flex; flex-direction: row; gap: 20px; max-width: 1200px; margin: auto; align-items: stretch; }
        .left-panel, .right-panel { flex: 1; background: var(--white); border: 4px solid var(--gold); padding: 20px; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.4); display: flex; flex-direction: column; }
        h2 { color: var(--red); text-align: center; text-transform: uppercase; letter-spacing: 1px; margin-top: 0; border-bottom: 2px solid var(--gold); padding-bottom: 10px; font-size: 18px; }

        /* M√ÄN H√åNH T·ª∂ L·ªÜ 1/4 - 1/4 - 1/2 */
        .display-section { display: flex; gap: 10px; margin: 15px 0; height: 120px; }
        
        .prev-container { flex: 1; background: #f5f5f5; border: 3px solid #ddd; border-radius: 15px; display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: inset 0 0 10px rgba(0,0,0,0.05); }
        .prev-label { font-size: 11px; color: #888; font-weight: bold; text-transform: uppercase; margin-bottom: 2px; }
        .prev-box { font-size: 45px; color: #555; font-weight: bold; line-height: 1; }
        
        .main-container { flex: 2; background: var(--dark); border: 4px solid var(--gold); border-radius: 15px; display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: 0 0 20px rgba(241,196,15,0.3); transition: 0.3s; }
        .main-box { font-size: 75px; color: var(--gold); font-weight: bold; line-height: 1; text-shadow: 0 0 15px var(--gold); }
        .win-number { background: var(--green) !important; color: var(--white) !important; border-color: #a5d6a7 !important; text-shadow: 0 0 20px #00ff00 !important; }

        .draw-counter { text-align: center; margin-bottom: 10px; font-weight: bold; color: var(--red); font-size: 16px; background: #ffebee; padding: 8px; border-radius: 10px; border: 1px dashed var(--red); }

        /* C·ª§M N√öT ƒêI·ªÄU KHI·ªÇN & AUTO */
        .btn-call { width: 100%; padding: 18px; background: linear-gradient(to bottom, #ff5252, #d32f2f); color: white; border: none; border-radius: 15px; font-size: 22px; font-weight: bold; cursor: pointer; box-shadow: 0 6px #8e0000; transition: 0.2s; }
        .btn-call:active { box-shadow: 0 0 #8e0000; transform: translateY(4px); }
        .btn-call:disabled { background: #999 !important; box-shadow: none; cursor: not-allowed; color: #eee !important; }
        
        .auto-controls { display: flex; gap: 8px; margin-top: 15px; }
        .btn-auto { flex: 1; padding: 12px 0; border: 2px solid #ddd; background: #f9f9f9; border-radius: 10px; font-weight: bold; font-size: 14px; cursor: pointer; color: #555; transition: 0.2s; }
        .btn-auto.active { background: var(--green); color: white; border-color: var(--green); box-shadow: 0 4px 10px rgba(46,125,50,0.4); }

        .btn-new-game { width: 100%; padding: 14px; background: #424242; color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 15px; box-shadow: 0 4px #212121; }

        /* X√ÅC MINH C·∫¢M ·ª®NG */
        .right-panel { gap: 12px; }
        .verify-card { background: #f9f9f9; border-radius: 15px; padding: 12px; border-left: 8px solid; border-right: 1px solid #eee; border-top: 1px solid #eee; border-bottom: 1px solid #eee; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; font-size: 13px; font-weight: bold; }
        .btn-bao-kinh { background: var(--red); color: var(--gold); border: 1px solid var(--gold); border-radius: 6px; padding: 6px 15px; font-weight: bold; font-size: 12px; cursor: pointer; box-shadow: 0 2px #b71c1c; }
        
        .check-inputs { display: flex; justify-content: space-between; gap: 4px; }
        .check-inputs input { width: 18%; padding: 12px 0; text-align: center; border-radius: 10px; border: 2px solid #ccc; font-weight: bold; font-size: 20px; color: var(--dark); background: white; cursor: pointer; transition: 0.2s; outline: none; }
        .check-inputs input.active-input { border: 3px solid var(--red) !important; background: #fff0f0 !important; box-shadow: 0 0 12px rgba(211,47,47,0.4); transform: scale(1.05); }
        .btn-verify { width: 100%; margin-top: 10px; padding: 12px; border-radius: 10px; border: none; color: white; font-weight: bold; font-size: 15px; cursor: pointer; }

        /* V√â NH√Ä C√ÅI */
        .ticket-box { background: #fff; border: 3px solid #1565c0; border-radius: 15px; padding: 15px; margin-top: 15px; }
        .ticket-box h3 { background: #1565c0; color: white; margin: -15px -15px 15px -15px; padding: 10px; border-radius: 10px 10px 0 0; text-transform: uppercase; font-size: 14px; text-align: center; }
        .ticket-cluster { margin-bottom: 10px; border-bottom: 2px dashed #90caf9; padding-bottom: 8px; }
        .ticket-cluster:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .ticket-table { width: 100%; border-collapse: separate; border-spacing: 3px; }
        .ticket-table td { width: 11%; height: 35px; text-align: center; border-radius: 6px; font-weight: bold; font-size: 15px; border: 1px solid #90caf9; background: #e3f2fd; color: #0d47a1; transition: 0.2s; }
        
        /* HI·ªÜU ·ª®NG √î TR·ªêNG M·ªú NH·∫†T ƒêI */
        .empty { background: #fdfdfd !important; border: 1px dashed #e0e0e0 !important; opacity: 0.4; }
        
        .revealed { background: var(--gold) !important; color: var(--red) !important; border-color: var(--gold) !important; box-shadow: 0 0 10px rgba(241, 196, 15, 0.6); transform: scale(1.05); }

        /* B·∫¢NG T·ªîNG 6 C·ªòT SIZE L·ªöN */
        .summary-title { text-align: center; font-size: 16px; color: var(--red); margin: 15px 0 10px 0; text-transform: uppercase; font-weight: bold; border-top: 2px dashed #ddd; padding-top: 15px; }
        #summary-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 6px; background: #fffde7; padding: 15px; border-radius: 15px; border: 2px solid var(--gold); flex-grow: 1; align-content: start; }
        .sum-cell { background: white; font-size: 18px; font-weight: bold; height: 42px; display: flex; align-items: center; justify-content: center; border-radius: 8px; color: #bbb; border: 1px solid #ddd; cursor: pointer; transition: 0.2s; }
        .sum-cell.active { background: var(--red); color: var(--gold); border-color: var(--gold); box-shadow: 0 3px 6px rgba(0,0,0,0.2); }
        .sum-cell.active:active { transform: scale(0.9); }

        #start-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 2000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        #canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1000; display: none; background: rgba(0,0,0,0.7); }
        #win-txt { position: fixed; top: 35%; left: 0; width: 100%; text-align: center; color: yellow; font-size: 45px; font-weight: 900; text-shadow: 0 0 20px red; z-index: 1001; display: none; }

        @media (max-width: 768px) { .main-layout { flex-direction: column; } }
    </style>
</head>
<body>

    <audio id="tts-audio" style="display: none;"></audio>

    <div id="start-overlay">
        <h1 style="color:var(--gold); font-size: 45px; text-shadow: 0 0 20px red;">üßß L√î T√î 2026 üßß</h1>
        <button onclick="initGame()" style="background:var(--gold); color:var(--red); padding: 25px 60px; font-size: 26px; border-radius: 60px; border:none; font-weight:bold; cursor:pointer; box-shadow: 0 0 30px var(--gold);">KHAI M·∫†C V√ÅN CH∆†I</button>
    </div>

    <canvas id="canvas"></canvas>
    <div id="win-txt"></div>

    <div class="main-layout">
        <div class="left-panel">
            <h2>üì¢ TR·∫†M ƒêI·ªÄU KHI·ªÇN</h2>
            
            <div class="draw-counter" id="draw-count">ƒê√£ b·ªëc: 0 s·ªë</div>

            <div class="display-section">
                <div class="prev-container">
                    <div class="prev-label">Tr∆∞·ªõc N·ªØa</div>
                    <div id="prev-num-2" class="prev-box">--</div>
                </div>
                <div class="prev-container">
                    <div class="prev-label">S·ªë Tr∆∞·ªõc</div>
                    <div id="prev-num-1" class="prev-box">--</div>
                </div>
                <div class="main-container">
                    <div id="main-num" class="main-box">--</div>
                </div>
            </div>
            
            <button id="btnCall" class="btn-call" onclick="bocSo()">B·ªêC S·ªê MAY M·∫ÆN</button>
            
            <div class="auto-controls">
                <button class="btn-auto active" id="btn-auto-0" onclick="setAutoMode(0)">B·∫•m Tay</button>
                <button class="btn-auto" id="btn-auto-7" onclick="setAutoMode(7)">T·ª± ƒë·ªông 7s</button>
                <button class="btn-auto" id="btn-auto-12" onclick="setAutoMode(12)">T·ª± ƒë·ªông 12s</button>
                <button class="btn-auto" id="btn-auto-18" onclick="setAutoMode(18)">T·ª± ƒë·ªông 18s</button>
            </div>

            <button class="btn-new-game" onclick="resetGame(false)">üîÑ T·∫†O V√ÅN CH∆†I M·ªöI</button>

            <div class="verify-card" style="border-left-color: var(--green); background: #e8f5e9; margin-top: 20px;">
                <div class="card-header">
                    <span style="color:var(--green)">X√°c Minh Nh√† C√°i</span> 
                    <div id="st-3"></div>
                </div>
                <div class="check-inputs">
                    <input type="text" class="in-3" readonly> <input type="text" class="in-3" readonly>
                    <input type="text" class="in-3" readonly> <input type="text" class="in-3" readonly>
                    <input type="text" class="in-3" readonly>
                </div>
                <button class="btn-verify" style="background:var(--green)" onclick="verifyUser(3)">X√ÅC MINH CHO NH√Ä C√ÅI</button>
            </div>

            <div class="ticket-box">
                <h3>üé´ V√â C·ª¶A NH√Ä C√ÅI</h3>
                <div id="ve-area"></div>
            </div>
        </div>

        <div class="right-panel">
            <h2>‚úÖ TRUNG T√ÇM KI·ªÇM ƒê·ªäNH</h2>
            
            <div class="verify-card" style="border-left-color: #ff5722;">
                <div class="card-header">
                    <span style="color:#ff5722">X√°c Minh Ng∆∞·ªùi 1</span> 
                    <button class="btn-bao-kinh" onclick="baoKinh(1)">üö® B√ÅO KINH</button>
                    <div id="st-1"></div>
                </div>
                <div class="check-inputs">
                    <input type="text" class="in-1" readonly> <input type="text" class="in-1" readonly>
                    <input type="text" class="in-1" readonly> <input type="text" class="in-1" readonly>
                    <input type="text" class="in-1" readonly>
                </div>
                <button class="btn-verify" style="background:#ff5722" onclick="verifyUser(1)">X√ÅC MINH NG∆Ø·ªúI 1</button>
            </div>

            <div class="verify-card" style="border-left-color: #2196f3;">
                <div class="card-header">
                    <span style="color:#2196f3">X√°c Minh Ng∆∞·ªùi 2</span> 
                    <button class="btn-bao-kinh" onclick="baoKinh(2)">üö® B√ÅO KINH</button>
                    <div id="st-2"></div>
                </div>
                <div class="check-inputs">
                    <input type="text" class="in-2" readonly> <input type="text" class="in-2" readonly>
                    <input type="text" class="in-2" readonly> <input type="text" class="in-2" readonly>
                    <input type="text" class="in-2" readonly>
                </div>
                <button class="btn-verify" style="background:#2196f3" onclick="verifyUser(2)">X√ÅC MINH NG∆Ø·ªúI 2</button>
            </div>

            <div class="summary-title">B·∫¢NG S·ªê ƒê√É RA (CH·∫†M ƒê·ªÇ CH·ªåN S·ªê KINH)</div>
            <div id="summary-grid"></div>
        </div>
    </div>

    <script>
        let daBoc = [], veData = [], isL = false;
        let fireworksTimeout = null, isFiring = false;
        let dDeck = [], dIdx = 0; 
        
        // H·ªÜ TH·ªêNG √ÇM THANH K√âP M·ªöI NH·∫§T
        function getVietnameseText(n) {
            const units = ["", "m·ªôt", "hai", "ba", "b·ªën", "nƒÉm", "s√°u", "b·∫£y", "t√°m", "ch√≠n"];
            if (n < 10) return "S·ªë " + units[n];
            if (n === 10) return "S·ªë m∆∞·ªùi";
            let chuc = Math.floor(n / 10);
            let donVi = n % 10;
            let strChuc = chuc === 1 ? "m∆∞·ªùi" : units[chuc] + " m∆∞∆°i";
            let strDonVi = "";
            if (donVi === 1 && chuc > 1) strDonVi = "m·ªët";
            else if (donVi === 4 && chuc > 1) strDonVi = "t∆∞";
            else if (donVi === 5) strDonVi = "lƒÉm";
            else if (donVi > 0) strDonVi = units[donVi];
            return "S·ªë " + strChuc + (strDonVi ? " " + strDonVi : "");
        }

        function playVoice(text) {
            const audioEl = document.getElementById('tts-audio');
            let url = `https://translate.googleapis.com/translate_tts?client=gtx&ie=UTF-8&tl=vi&q=${encodeURIComponent(text)}`;
            audioEl.src = url;
            
            audioEl.play().catch(e => {
                console.log("D√πng gi·ªçng d·ª± ph√≤ng do tr√¨nh duy·ªát ch·∫∑n:", e);
                if ('speechSynthesis' in window) {
                    window.speechSynthesis.cancel();
                    let u = new SpeechSynthesisUtterance(text);
                    u.lang = 'vi-VN';
                    u.rate = 0.9;
                    window.speechSynthesis.speak(u);
                }
            });
        }

        let autoDrawInterval = null;
        let activeVerifyInput = null;

        // 2. B·∫¢NG T·ªîNG & C·∫¢M ·ª®NG
        function drawSummary() {
            const grid = document.getElementById('summary-grid');
            grid.innerHTML = '';
            for(let i=1; i<=90; i++){
                let c = document.createElement('div');
                c.className = 'sum-cell'; 
                c.id = 's-'+i; 
                c.innerText = i;
                
                c.onclick = () => {
                    if(!activeVerifyInput) return; 
                    
                    if(!daBoc.includes(i)) {
                        alert("S·ªë " + i + " ch∆∞a ƒë∆∞·ª£c b·ªëc, kh√¥ng th·ªÉ ch·ªçn gian l·∫≠n!");
                        return;
                    }
                    
                    activeVerifyInput.value = i;
                    activeVerifyInput.classList.remove('active-input');
                    
                    let parent = activeVerifyInput.parentElement;
                    let inputs = Array.from(parent.querySelectorAll('input'));
                    let currentIndex = inputs.indexOf(activeVerifyInput);
                    
                    activeVerifyInput = null; 
                    
                    for(let j = currentIndex + 1; j < inputs.length; j++) {
                        if(!inputs[j].value) {
                            inputs[j].classList.add('active-input');
                            activeVerifyInput = inputs[j];
                            break;
                        }
                    }
                };
                grid.appendChild(c);
            }
        }

        function setupInputListeners() {
            document.querySelectorAll('.check-inputs input').forEach(inp => {
                if(!inp.classList.contains('in-3')) { 
                    inp.addEventListener('click', function() {
                        document.querySelectorAll('.check-inputs input').forEach(i => i.classList.remove('active-input'));
                        this.classList.add('active-input');
                        activeVerifyInput = this;
                    });
                }
            });
        }

        function initGame() {
            document.getElementById('start-overlay').style.display = 'none';
            playVoice("B·∫Øt ƒë·∫ßu v√°n m·ªõi");
            setupInputListeners();
            resetGame(true);
        }

        // 3. AUTO-DRAW
        function setAutoMode(seconds) {
            clearInterval(autoDrawInterval);
            document.querySelectorAll('.btn-auto').forEach(btn => btn.classList.remove('active'));
            document.getElementById('btn-auto-' + seconds).classList.add('active');
            
            if (seconds > 0 && !isL && daBoc.length < 90) {
                autoDrawInterval = setInterval(() => { bocSo(); }, seconds * 1000);
            }
        }

        function stopAutoMode() {
            clearInterval(autoDrawInterval);
            document.querySelectorAll('.btn-auto').forEach(btn => btn.classList.remove('active'));
            document.getElementById('btn-auto-0').classList.add('active');
        }

        // 4. THU·∫¨T TO√ÅN NH√Ä C√ÅI √âP T·ªà L·ªÜ 40%
        function prepareD() {
            dDeck = []; dIdx = 0;
            let arr = Array.from({length: 90}, (_, i) => i + 1);
            for (let i = arr.length - 1; i > 0; i--) {
                let j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            if (Math.random() < 0.40 && veData.length > 0) {
                let vR = [];
                for (let r = 0; r < 9; r++) {
                    let row = veData[r].filter(n => n !== null);
                    if (row.length === 5) vR.push(row);
                }
                if (vR.length > 0) {
                    let tR = [...vR[Math.floor(Math.random() * vR.length)]];
                    arr = arr.filter(n => !tR.includes(n));
                    let wT = Math.floor(Math.random() * 11) + 30; 
                    let lT = tR.pop();
                    let fP = arr.splice(0, wT - 1 - tR.length);
                    fP = fP.concat(tR);
                    for (let i = fP.length - 1; i > 0; i--) {
                        let j = Math.floor(Math.random() * (i + 1));
                        [fP[i], fP[j]] = [fP[j], fP[i]];
                    }
                    dDeck = [...fP, lT, ...arr];
                    return; 
                }
            }
            dDeck = arr; 
        }

        function bocSo() {
            if (isL || daBoc.length >= 90 || dIdx >= 90) return; 
            
            // --- THU·∫¨T TO√ÅN ƒê·∫®Y 2 S·ªê TR∆Ø·ªöC ---
            let curMain = document.getElementById('main-num').innerText;
            let curPrev1 = document.getElementById('prev-num-1').innerText;

            if (curPrev1 !== "--" && curMain !== "--") {
                document.getElementById('prev-num-2').innerText = curPrev1;
            }
            if (curMain !== "--") {
                document.getElementById('prev-num-1').innerText = curMain;
            }
            // ---------------------------------

            let n = dDeck[dIdx++]; 
            daBoc.push(n);
            
            document.getElementById('main-num').innerText = n;
            document.getElementById('draw-count').innerText = `ƒê√£ b·ªëc: ${daBoc.length} s·ªë`;
            
            playVoice(getVietnameseText(n));
            
            let cell = document.getElementById('s-'+n);
            if (cell) cell.classList.add('active');
            let tCell = document.getElementById('v-'+n);
            if (tCell) tCell.classList.add('revealed');
            
            chkAutoLock();
        }

        // 5. B√ÅO KINH
        function baoKinh(uId) {
            if (daBoc.length === 0) { alert("Ch∆∞a b·ªëc s·ªë n√†o!"); return; }
            stopAutoMode(); 
            isL = true;
            document.getElementById('btnCall').disabled = true;
            
            let lastNumber = daBoc[daBoc.length - 1];
            let inputs = document.querySelectorAll('.in-' + uId);
            
            inputs.forEach(i => { i.value = ""; i.classList.remove('active-input'); });
            
            inputs[0].value = lastNumber;
            inputs[0].style.borderColor = "var(--red)"; 
            inputs[0].style.background = "#fffde7"; 
            inputs[0].style.color = "var(--red)"; 
            
            inputs[1].classList.add('active-input');
            activeVerifyInput = inputs[1];
        }

        function chkAutoLock() {
            for (let r = 0; r < 9; r++) {
                let winNumbers = [];
                for (let c = 0; c < 9; c++) {
                    if (veData[r][c] && daBoc.includes(veData[r][c])) {
                        winNumbers.push(veData[r][c]);
                    }
                }
                if (winNumbers.length === 5) {
                    stopAutoMode();
                    isL = true;
                    document.getElementById('btnCall').disabled = true;
                    document.getElementById('main-num').classList.add('win-number');
                    
                    let lastNumber = daBoc[daBoc.length - 1];
                    winNumbers = winNumbers.filter(n => n !== lastNumber);
                    winNumbers.unshift(lastNumber);
                    
                    let inputs = document.querySelectorAll('.in-3');
                    for(let i = 0; i < 5; i++) {
                        inputs[i].value = winNumbers[i];
                        if (i === 0) {
                            inputs[i].style.borderColor = "var(--red)";
                            inputs[i].style.background = "#fffde7";
                            inputs[i].style.color = "var(--red)";
                        } else {
                            inputs[i].style.borderColor = "var(--gold)";
                        }
                    }
                    return true;
                }
            }
            return false;
        }

        function triggerWin(message) {
            stopAutoMode();
            isL = true;
            document.getElementById('btnCall').disabled = true;
            document.querySelectorAll('.check-inputs input').forEach(i => i.classList.remove('active-input'));
            activeVerifyInput = null;
            
            let winTxt = document.getElementById('win-txt');
            winTxt.innerHTML = message + `
                <br><span style="font-size: 18px; color: white; text-shadow: none; display: block; margin-top: 15px;">(T·ª± ƒë·ªông ƒë√≥ng ph√°o hoa sau 10s)</span>
                <button onclick="closeWinScreen()" style="margin-top:20px; padding: 12px 40px; font-size: 20px; font-weight: bold; background: var(--gold); color: var(--red); border: none; border-radius: 50px; cursor: pointer; box-shadow: 0 0 15px var(--gold); pointer-events: auto; text-transform: uppercase;">ƒê√ìNG PH√ÅO HOA NGAY</button>`;
            winTxt.style.display = 'block';
            
            startFireworks();
            clearTimeout(fireworksTimeout);
            fireworksTimeout = setTimeout(() => { closeWinScreen(); }, 10000);
            
            playVoice("Ch√∫c m·ª´ng, ƒë√£ kinh!");
        }

        function closeWinScreen() {
            clearTimeout(fireworksTimeout);
            stopFireworks();
            document.getElementById('win-txt').style.display = 'none';
        }

        function verifyUser(uId) {
            let ins = document.querySelectorAll('.in-'+uId), ct = 0, total = 0;
            ins.forEach(i => {
                let v = parseInt(i.value);
                if(v) { total++; if(daBoc.includes(v)) { i.style.background="#c8e6c9"; ct++; } else { i.style.background="#ffcdd2"; } }
            });
            let st = document.getElementById('st-'+uId);
            if(total < 5) return alert("B·∫°n ch∆∞a b·∫•m ƒë·ªß 5 s·ªë tr√™n b·∫£ng t·ªïng!");
            
            if(ct === 5) { 
                st.innerHTML = "‚úÖ H·ª¢P L·ªÜ!"; st.style.color = "var(--green)"; 
                if (uId === 3) { triggerWin(`üéá NH√Ä C√ÅI ƒê√É KINH! üßß`); } 
                else { triggerWin(`üéá NG∆Ø·ªúI CH∆†I ${uId} KINH! üßß`); }
            }
            else { st.innerHTML = "‚ùå SAI S·ªê!"; st.style.color = "red"; }
        }

        function taoVe() {
            const vArea = document.getElementById('ve-area');
            vArea.innerHTML = '';
            veData = Array.from({ length: 9 }, () => Array(9).fill(null));
            let ps = Array.from({length: 9}, (_, c) => {
                let min = c * 10 || 1, max = (c === 8) ? 90 : (c * 10 + 9);
                return Array.from({length: max-min+1}, (_, i) => min + i).sort(() => Math.random() - 0.5);
            });
            for (let r = 0; r < 9; r++) {
                let cs = [0,1,2,3,4,5,6,7,8].sort(() => Math.random() - 0.5).slice(0, 5);
                cs.forEach(c => { veData[r][c] = ps[c].pop(); });
            }
            for (let cluster = 0; cluster < 3; cluster++) {
                let div = document.createElement('div');
                div.className = 'ticket-cluster';
                let html = '<table class="ticket-table">';
                for (let r = cluster * 3; r < (cluster + 1) * 3; r++) {
                    html += '<tr>';
                    for (let c = 0; c < 9; c++) {
                        let val = veData[r][c];
                        if (val) html += `<td id="v-${val}">${val}</td>`;
                        else html += `<td class="empty"></td>`;
                    }
                    html += '</tr>';
                }
                div.innerHTML = html + '</table>';
                vArea.appendChild(div);
            }
        }

        function resetGame(force = false) {
            if (!force) {
                if(!confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën T·∫†O V√ÅN CH∆†I M·ªöI? (To√†n b·ªô s·ªë s·∫Ω b·ªã x√≥a)")) return;
            }
            
            stopAutoMode();
            isL = false; daBoc = [];
            activeVerifyInput = null;
            document.getElementById('btnCall').disabled = false;
            
            let mainNum = document.getElementById('main-num');
            mainNum.innerText = "--"; mainNum.classList.remove('win-number');
            
            document.getElementById('prev-num-1').innerText = "--";
            document.getElementById('prev-num-2').innerText = "--";
            
            document.getElementById('draw-count').innerText = "ƒê√£ b·ªëc: 0 s·ªë";
            
            closeWinScreen();
            
            document.querySelectorAll('.check-inputs input').forEach(i => {
                i.value = ""; i.style.background="white"; i.style.borderColor = "#ccc"; i.style.color = "var(--dark)"; i.classList.remove('active-input');
            });
            document.querySelectorAll('[id^="st-"]').forEach(s => s.innerHTML = "");
            
            drawSummary(); taoVe(); prepareD(); 
        }

        function startFireworks() {
            const cv = document.getElementById('canvas'), ctx = cv.getContext('2d');
            if (isFiring) return; 
            isFiring = true;
            cv.style.display = 'block';
            cv.width = window.innerWidth; cv.height = window.innerHeight;
            let pts = [];
            function anim() {
                if (cv.style.display === 'none') { isFiring = false; return; }
                ctx.fillStyle = 'rgba(0,0,0,0.15)'; ctx.fillRect(0,0,cv.width, cv.height);
                if (Math.random() < 0.2) {
                    let x = Math.random()*cv.width, y = Math.random()*cv.height, c = `hsl(${Math.random()*360},100%,50%)`;
                    for(let i=0; i<40; i++) pts.push({x,y,dx:Math.random()*6-3,dy:Math.random()*6-3,c,l:70});
                }
                pts.forEach((p,i) => {
                    p.x+=p.dx; p.y+=p.dy; p.l--;
                    ctx.fillStyle=p.c; ctx.beginPath(); ctx.arc(p.x,p.y,2,0,Math.PI*2); ctx.fill();
                    if(p.l<=0) pts.splice(i,1);
                });
                requestAnimationFrame(anim);
            }
            anim();
        }

        function stopFireworks() { document.getElementById('canvas').style.display = 'none'; isFiring = false; }
    </script>
</body>
</html>
